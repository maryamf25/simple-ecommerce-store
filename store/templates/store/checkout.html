{% extends "store/base.html" %} {% load static %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'store/css/checkout.css' %}" />
{% endblock %} {% block content %}
<div class="container">
  <h2>Checkout</h2>

  {% if is_buy_now %}
  <div class="checkout-product">
    <p><strong>Product:</strong> {{ product.name }}</p>
    <img
      src="{{ product.image.url }}"
      alt="{{ product.name }}"
      style="max-width: 150px"
    />

    <div>
      <label><strong>Quantity:</strong></label>
      <div class="quantity-controls">
        <button type="button" id="decrease">â€“</button>
        <input
          type="number"
          id="quantity"
          name="quantity"
          value="{{ quantity }}"
          min="1"
          readonly
        />
        <button type="button" id="increase">+</button>
      </div>
    </div>

    <p><strong>Unit Price:</strong> Rs. {{ product.price }}</p>
    <p>
      <strong>Total Price:</strong> Rs.
      <span id="total">{{ total_price }}</span>
    </p>
  </div>

  <form method="POST" action="{% url 'place_order' %}">
    {% csrf_token %}
    <input type="hidden" name="is_buy_now" value="1" />
    <input type="hidden" name="product_id" value="{{ product.id }}" />
    <input
      type="hidden"
      name="final_quantity"
      id="final_quantity"
      value="{{ quantity }}"
    />
    <button type="submit">Place Order</button>
  </form>
  {% else %}
  <div class="checkout-cart">
    {% if cart_items %}
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Image</th>
          <th>Price</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr>
          <td>{{ item.product.name }}</td>
          <td>
            <img
              src="{{ item.product.image.url }}"
              alt="{{ item.product.name }}"
              style="max-width: 100px"
            />
          </td>
          <td>Rs. {{ item.product.price }}</td>
          <td>{{ item.quantity }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3>Grand Total: Rs. {{ total_price }}</h3>

    <form method="POST" action="{% url 'place_order' %}">
      {% csrf_token %}
      <input type="hidden" name="is_buy_now" value="0" />
      <input type="hidden" name="product_id" value="{{ product.id }}" />
      <input
        type="hidden"
        name="final_quantity"
        id="final_quantity"
        value="{{ quantity }}"
      />
      <button type="submit">Place Order</button>
    </form>
    {% else %}
    <p>Your cart is empty.</p>
    {% endif %}
  </div>
  {% endif %}
</div>

<style>
  .quantity-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .quantity-controls input {
    width: 50px;
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th,
  td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: center;
  }
</style>

{% if is_buy_now %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const decreaseBtn = document.getElementById("decrease");
    const increaseBtn = document.getElementById("increase");
    const quantityInput = document.getElementById("quantity");
    const finalQuantityInput = document.getElementById("final_quantity");
    const totalPriceEl = document.getElementById("total");
    const unitPrice = {{ product.price }};

    function updateTotal() {
      const qty = parseInt(quantityInput.value);
      totalPriceEl.textContent = qty * unitPrice;
      finalQuantityInput.value = qty;
    }

    increaseBtn.addEventListener("click", () => {
      quantityInput.value = parseInt(quantityInput.value) + 1;
      updateTotal();
    });

    decreaseBtn.addEventListener("click", () => {
      if (parseInt(quantityInput.value) > 1) {
        quantityInput.value = parseInt(quantityInput.value) - 1;
        updateTotal();
      }
    });

    updateTotal(); // initialize
  });
</script>
{% endif %} {% endblock %}
